Vagrant.configure("2") do |config|
  BOX_NAME = "ubuntu/jammy64"
  BOX_MEMORY = 1024
  BOX_CPUS = 1

  # -------- Server (Controller) --------
  config.vm.define "rouarrakS" do |server|
    server.vm.box = BOX_NAME
    server.vm.hostname = "rouarrakS"
    server.vm.network "private_network", ip: "192.168.56.110"

    server.vm.provider "virtualbox" do |v|
      v.name = "rouarrakS"
      v.memory = BOX_MEMORY
      v.cpus = BOX_CPUS
    end

    server.vm.provision "shell", inline: <<-SHELL
      sudo apt-get update -y
      sudo apt-get install -y curl sshpass git vim
      sudo swapoff -a
      sudo sed -i '/ swap / s/^/#/' /etc/fstab

      # Install K3s server
      curl -sfL https://get.k3s.io | sh -

      # Wait for K3s to finish initializing and then export token + kubeconfig
      while [ ! -f /var/lib/rancher/k3s/server/node-token ]; do
        echo "Waiting for k3s token..."
        sleep 2
      done

      # Export node token and kubeconfig to the shared /vagrant folder so agents can read them
      sudo cp /var/lib/rancher/k3s/server/node-token /vagrant/node-token
      sudo cp /etc/rancher/k3s/k3s.yaml /vagrant/k3s.yaml
      sudo chown vagrant:vagrant /vagrant/node-token /vagrant/k3s.yaml || true

      # Also configure kubectl for vagrant user on the server itself
      mkdir -p /home/vagrant/.kube
      sudo cp /etc/rancher/k3s/k3s.yaml /home/vagrant/.kube/config
      sudo chown vagrant:vagrant /home/vagrant/.kube/config

      # # **Set KUBECONFIG automatically for vagrant user**
      # echo 'export KUBECONFIG=/home/vagrant/.kube/config' >> /home/vagrant/.bashrc
    SHELL
  end

  # -------- Worker (Agent) --------
  config.vm.define "rouarrakSW" do |worker|
    worker.vm.box = BOX_NAME
    worker.vm.hostname = "rouarrakSW"
    worker.vm.network "private_network", ip: "192.168.56.111"

    worker.vm.provider "virtualbox" do |v|
      v.name = "rouarrakSW"
      v.memory = BOX_MEMORY
      v.cpus = BOX_CPUS
    end

    worker.vm.provision "shell", inline: <<-SHELL
      sudo apt-get update -y
      sudo apt-get install -y curl sshpass git vim
      sudo swapoff -a
      sudo sed -i '/ swap / s/^/#/' /etc/fstab

      # Wait until server is ready
      SERVER_IP="192.168.56.110"
      while ! nc -z $SERVER_IP 6443; do
        echo "Waiting for server $SERVER_IP..."
        sleep 5
      done
      # Read K3s token exported by server into shared /vagrant folder
      # Wait until the token file is available (server writes it)
      while [ ! -f /vagrant/node-token ]; do
        echo "Waiting for /vagrant/node-token..."
        sleep 2
      done
      TOKEN=$(cat /vagrant/node-token)

      # Install K3s agent using the token from the shared folder
      curl -sfL https://get.k3s.io | K3S_URL=https://$SERVER_IP:6443 K3S_TOKEN=$TOKEN sh -

      # Note: the agent does not have the server kubeconfig at /etc/rancher/k3s/k3s.yaml
      # Keep kubectl installed if needed
    SHELL
  end
end
